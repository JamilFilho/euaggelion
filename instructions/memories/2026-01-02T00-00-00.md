# Memória de Atualização - 2026-01-02T00-00-00

## Descrição

Este documento registra a finalização da integração do sistema de notificações WebPush com o fluxo de build do TinaCMS no projeto "Euaggelion". A implementação conecta a publicação de novos conteúdos (artigos, wiki e páginas) ao envio automático de notificações push para usuários inscritos.

## Atualizações Realizadas

### 1. Criação do Workflow do GitHub Actions

- **Descrição**: Implementação de um workflow que monitora mudanças em conteúdo e dispara o webhook de notificações.
- **Arquivos Criados**:
  - `.github/workflows/tina-webhook.yml`: Workflow que monitora `content/**` e `tina/**`
- **Funcionalidades**:
  - Dispara automaticamente em pushes que afetam diretórios de conteúdo
  - Coleta arquivos adicionados, modificados e removidos
  - Envia POST para `/api/tina-webhook` com lista de arquivos alterados
  - Suporta autenticação via `WEBPUSH_API_KEY` (Bearer) ou `WEBHOOK_SECRET` (header)
  - Usa `SITE_URL` como variável configurável (default: https://euaggelion.com.br)
  - Retorna gracefully se nenhum arquivo foi alterado

### 2. Documentação de Integração

- **Descrição**: Criação de guia detalhado sobre configuração e uso da integração WebPush.
- **Arquivos Criados**:
  - `instructions/memories/2026-01-02T00-00-00.md`: Registro de memória (este arquivo)
  - (documento anterior `instructions/WEBPUSH_INTEGRATION.md` descontinuado)
- **Conteúdo**:
  - Descrição de variáveis de ambiente necessárias
  - Instruções de configuração de secrets do GitHub
  - Exemplos de teste com cURL
  - Notas técnicas sobre o fluxo de notificações

### 3. Verificação e Consolidação da Stack Existente

- **Descrição**: Confirmação de que todos os componentes já implementados funcionam corretamente em conjunto.
- **Componentes Verificados**:
  - `app/api/tina-webhook/route.tsx`: Endpoint que processa webhooks e dispara notificações
  - `app/actions.ts`: Server actions para `subscribeUser`, `unsubscribeUser` e `sendNotificationToAll`
  - `lib/kv.tsx`: Camada de persistência em Upstash KV (Redis)
  - `proxy.ts`: Middleware com autenticação, rate limiting e CORS
  - `public/sw.js`: Service Worker para registrar subscriptions no cliente
  - `components/pushNotification.tsx`: Componentes de UI para gerenciamento de inscrições
- **Detalhes**:
  - Webhook valida autenticação via middleware centralizado
  - Extrai metadados (título, categoria) dos arquivos MDX usando `gray-matter`
  - Formata mensagens de notificação por tipo de conteúdo (article, wiki, page)
  - Envia notificações em paralelo com tratamento de subscriptions expiradas (410 Gone)
  - Remove subscriptions inativas automaticamente

## Fluxo de Funcionamento

```
TinaCMS Publica Conteúdo (MDX)
          ↓
   Commit → push para main
          ↓
   GitHub Actions detecta `content/**`
          ↓
   Workflow coleta arquivos alterados
          ↓
   POST → /api/tina-webhook
   (Authorization: Bearer WEBPUSH_API_KEY)
          ↓
   Middleware valida autenticação + rate limit + CORS
          ↓
   Endpoint lê arquivos MDX com `gray-matter`
          ↓
   Extrai: title, category, published, slug
          ↓
   Filtra apenas conteúdo publicado
          ↓
   Formata notificação (título + body)
          ↓
   sendNotificationToAll() envia via web-push
          ↓
   Notificação entregue aos subscribed users
```

## Variáveis de Ambiente Necessárias

### Servidor (Backend)

- `VAPID_PRIVATE_KEY`: Chave privada VAPID para assinar notificações push
- `KV_REST_API_URL`: URL da API Upstash KV (Redis)
- `KV_REST_API_TOKEN`: Token de autenticação Upstash KV
- `WEBPUSH_API_KEY`: Chave de autenticação do webhook (preferido sobre WEBHOOK_SECRET)
- `WEBHOOK_SECRET`: Alternativa simples para autenticar webhook (fallback)
- `TINA_TOKEN`: Token do TinaCMS (já existente)
- `NODE_ENV`: Ambiente (development/production)

### Cliente (Frontend)

- `NEXT_PUBLIC_VAPID_PUBLIC_KEY`: Chave pública VAPID para registrar subscriptions no cliente

### GitHub Secrets

- `WEBPUSH_API_KEY`: Chave para autorizar POST ao webhook
- `WEBHOOK_SECRET`: Alternativa (se não usar WEBPUSH_API_KEY)
- `SITE_URL`: URL da aplicação (default: https://euaggelion.com.br)

## Configuração no GitHub

1. Abra Settings → Secrets and variables → Actions
2. Adicione novo secret `WEBPUSH_API_KEY` com valor seguro (gere uma string aleatória forte)
3. (Opcional) Configure `SITE_URL` se usar staging/diferentes ambientes
4. O workflow `.github/workflows/tina-webhook.yml` já está presente e ativado

## Testes Locais

### Simular webhook com cURL

```bash
curl -X POST https://euaggelion.com.br/api/tina-webhook \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_WEBPUSH_API_KEY" \
  -d '{"files":"content/articles/test-article.mdx content/wiki/test-wiki.mdx"}'
```

### Verificar subscriptions ativas

Aceda a `/api/tina-webhook` com GET para health check:

```bash
curl -I https://euaggelion.com.br/api/tina-webhook
```

Esperado: `200 OK` com informações de status.

## Tratamento de Erros e Casos Especiais

- **Subscription expirada (410 Gone)**: Removida automaticamente do KV
- **Arquivo não publicado**: Ignorado no webhook
- **Arquivo fora de content/**: Ignorado por segurança (path traversal protection)
- **Rate limit (429)**: Retry após X segundos (header `X-RateLimit-Reset`)
- **Origem não permitida**: Rejeitado com status 403
- **Sem autenticação**: Retorna 401

## Próximos Passos

- **Ativar secrets no GitHub**: Adicionar `WEBPUSH_API_KEY` ao repositório
- **Teste com conteúdo real**: Fazer commit em `content/articles/` e verificar se notificação foi entregue
- **Monitoramento**: Ativar logs e webhooks de entrega no Upstash/web-push
- **Alertas**: Configurar alertas se taxa de falha de notificação exceder 10%
- **Backup de keys**: Guardar VAPID keys em local seguro (1password, vault, etc.)

## Conclusão

O sistema de WebPush está completamente integrado ao fluxo de publicação do TinaCMS. Qualquer novo conteúdo publicado dispara automaticamente notificações para usuários inscritos. A arquitetura é robusta, com tratamento de erros, rate limiting, autenticação centralizada e limpeza automática de subscriptions expiradas. Pronto para produção.
