````markdown
# Memória de Atualização - 2026-01-02T12-00-00

## Descrição

Este documento registra as correções e melhorias implementadas no sistema de parsing de referências bíblicas do projeto "Euaggelion". As mudanças resolvem problemas na identificação de intervalos de versículos (issue #9) e adicionam suporte para múltiplos capítulos do mesmo livro com links/modais separados.

## Problemas Resolvidos

### Issue #9: BibliaParse com erro na identificação de intervalos de versículos

**Problema:**
- O parser reconhecia passagens como "Ezequiel 9:3–5" (com en-dash)
- Mas ao processar, retornava apenas o primeiro verso (versículo 3)
- Em vez do intervalo completo (3 a 5)

**Causa:**
- A função `parseReferenceDetails()` usava apenas o hífen simples `-` para dividir intervalos
- Textos em português utilizam en-dash `–` ou em-dash `—`, não capturados pelo código

**Solução Implementada:**
- Normalização de todos os tipos de hífens/travessões antes do processamento
- Adicionado `replace(/[\-–—]/g, '-')` para converter `–` e `—` em `-`
- Também adicionado `.trim()` ao fazer parse dos números para evitar erros com espaços

**Arquivo modificado:**
- `lib/bibleParser.ts` → função `parseReferenceDetails()`

**Casos suportados após correção:**
- ✓ `Ezequiel 9:3–5` (en-dash)
- ✓ `Ezequiel 9:3-5` (hífen)
- ✓ `Ezequiel 9:3—5` (em-dash)
- ✓ `2 Tessalonicenses 2:3, 7` (versículos separados por vírgula)
- ✓ Múltiplos intervalos: `1:1–3, 5–7`
- ✓ Múltiplos capítulos: `1:1–3; 2:4–6`

---

### Suporte para Múltiplos Capítulos com Links Separados

**Problema inicial:**
- Referências com múltiplos capítulos (ex: `1 João 3:11-24; 4:7-21`) criavam um único link/modal
- Usuário precisava clicar em um link único que abria ambos os capítulos
- Não havia forma de acessar apenas um capítulo específico

**Solução Implementada:**

#### 1. Melhoria do Regex de Captura (lib/bibleParser.ts)

Modificado `getBibleRegex()` para capturar múltiplos capítulos:

**Antes:**
```typescript
return new RegExp(`\\b(${escapedBooks})\\b\\s+(\\d+(?:[:\\.]\\s*[\\d,\\-–—\\s]+)?)`, 'gi');
```

**Depois:**
```typescript
const singleChapter = `\\d+(?:[:\\.]\\s*[\\d,\\-–—\\s]+)?`;
const multipleChapters = `${singleChapter}(?:\\s*;\\s*${singleChapter})*`;
return new RegExp(`\\b(${escapedBooks})\\b\\s+(${multipleChapters})`, 'gi');
```

**Resultado:**
- Captura `1 João 3:11-24; 4:7-21` completo em uma única referência
- Permite múltiplos capítulos separados por ponto-e-vírgula

#### 2. Links/Modais Separados por Capítulo (components/content/Bible/BibliaLink.tsx)

**Antes:**
- Uma única referência renderizada como um link único
- Texto: `1 João 3:11-24; 4:7-21`
- Link: abre ambos os capítulos

**Depois:**
- Detecta múltiplos capítulos na referência
- Cria links separados para cada capítulo
- Mantém estrutura visual original: `1 João 3:11-24; 4:7-21`
- Cada parte é um link clickável diferente

**Comportamento específico:**
- Primeira citação inclui nome do livro: `1 João 3:11-24`
- Citações subsequentes apenas capítulo e versículos: `4:7-21`
- Separador visual: `"; "`
- Ícone de cópia: apenas na primeira referência

**Exemplos de renderização:**

| Entrada | Saída | Resultado |
|---------|-------|-----------|
| `1 João 3:11-24; 4:7-21` | `1 João 3:11-24; 4:7-21` | 2 links: cap.3 e cap.4 |
| `Mateus 5:1-10; 6:25-34; 7:1-12` | `Mateus 5:1-10; 6:25-34; 7:1-12` | 3 links: cap.5, 6 e 7 |
| `Mateus 5:1-10` | `Mateus 5:1-10` | 1 link (comportamento original) |

---

## Atualizações de Arquivo

### 1. lib/bibleParser.ts

**Funções modificadas:**

#### `getBibleRegex(bookNames: string[])`
- Atualizado regex para suportar múltiplos capítulos separados por ponto-e-vírgula
- Padrão agora: `Livro Cap:Ver[,Ver-Ver]; Cap:Ver[,Ver-Ver]; ...`

**Antes:**
```typescript
return new RegExp(`\\b(${escapedBooks})\\b\\s+(\\d+(?:[:\\.]\\s*[\\d,\\-–—\\s]+)?)`, 'gi');
```

**Depois:**
```typescript
const singleChapter = `\\d+(?:[:\\.]\\s*[\\d,\\-–—\\s]+)?`;
const multipleChapters = `${singleChapter}(?:\\s*;\\s*${singleChapter})*`;
return new RegExp(`\\b(${escapedBooks})\\b\\s+(${multipleChapters})`, 'gi');
```

#### `parseReferenceDetails(refStr: string)`
- Normalização de hífens/travessões: `replace(/[\-–—]/g, '-')`
- Trim nos números parseados para evitar erros de whitespace
- Já suportava múltiplos capítulos através do split por `;`

**Antes:**
```typescript
if (vTrimmed.includes('-')) {
  const [start, end] = vTrimmed.split('-').map(n => parseInt(n));
  if (!isNaN(start) && !isNaN(end)) {
    ranges.push([start, end]);
  }
}
```

**Depois:**
```typescript
const normalizedVerse = vTrimmed.replace(/[\-–—]/g, '-');
if (normalizedVerse.includes('-')) {
  const [start, end] = normalizedVerse.split('-').map(n => parseInt(n.trim()));
  if (!isNaN(start) && !isNaN(end)) {
    ranges.push([start, end]);
  }
}
```

---

### 2. components/content/Bible/BibliaLink.tsx

**Componente modificado:** `BibliaLink`

**Alterações principais:**

1. **Tipagem melhorada:**
   ```typescript
   let match: RegExpExecArray | null;
   ```

2. **Detecção e processamento de múltiplos capítulos:**
   - Verifica `reference.chapters.length > 1`
   - Itera sobre cada capítulo com `.forEach((chapterData, chapterIndex) => {...})`

3. **Renderização inteligente do texto:**
   ```typescript
   let chapterRefText = chapterIndex === 0 
     ? `${bookNameMatch} ${chapterNum}`
     : `${chapterNum}`;
   ```
   - Primeira referência: `1 João 3`
   - Subsequentes: `4`, `5`, etc.

4. **Links/Modais separados:**
   - Cada capítulo gera seu próprio Link ou span
   - Mantém estrutura `"1 João 3:11-24; 4:7-21"` visualmente
   - Mas funcionalmente são links diferentes

5. **Ícone de cópia:**
   ```typescript
   {chapterIndex === 0 && <Copy className="h-4 w-4 ml-1" />}
   ```
   - Aparece apenas na primeira referência

6. **Retrocompatibilidade:**
   - Referências com um único capítulo mantêm comportamento original
   - Lógica no bloco `else` para `reference.chapters.length <= 1`

---

## Fluxo Técnico Completo

### Parsing de "1 João 3:11-24; 4:7-21"

1. **Regex captura:**
   - `match[1]`: `"1 João"`
   - `match[2]`: `"3:11-24; 4:7-21"`

2. **parseReferenceDetails("3:11-24; 4:7-21"):**
   - Split por `;`: `["3:11-24", "4:7-21"]`
   - Primeira parte: `chapterNum = 3`, `versesStr = "11-24"`
   - Normaliza `11-24` → `11-24` (já é hífen simples)
   - Cria range: `[11, 24]`
   - Segunda parte: `chapterNum = 4`, `versesStr = "7-21"`
   - Cria range: `[7, 21]`
   - Retorna: `[{chapter: 3, verses: [], ranges: [[11, 24]]}, {chapter: 4, verses: [], ranges: [[7, 21]]}]`

3. **BibliaLink renderização:**
   - Detecta `chapters.length = 2` (múltiplos capítulos)
   - Itera:
     - **Índice 0:** `"1 João 3:11-24"` → Link para `/biblia/nvt/1joao/3?highlight=...`
     - **Separador:** `"; "`
     - **Índice 1:** `"4:7-21"` → Link para `/biblia/nvt/1joao/4?highlight=...`

4. **Resultado visual:**
   ```
   1 João 3:11-24; 4:7-21
   └─ link cap.3   └─ link cap.4
   ```

---

## Casos de Teste

### ✓ Caso 1: Intervalo com en-dash
```
Input: "Ezequiel 9:3–5"
Parse result: {chapter: 9, verses: [], ranges: [[3, 5]]}
Modal mostra: versículos 3, 4, 5
```

### ✓ Caso 2: Múltiplos capítulos
```
Input: "1 João 3:11-24; 4:7-21"
Renderização: "1 João 3:11-24; 4:7-21"
Link 1: abre capítulo 3, versículos 11-24
Link 2: abre capítulo 4, versículos 7-21
```

### ✓ Caso 3: Versículos separados por vírgula
```
Input: "2 Tessalonicenses 2:3, 7"
Parse result: {chapter: 2, verses: [3, 7], ranges: []}
Modal mostra: versículos 3 e 7
```

### ✓ Caso 4: Múltiplos intervalos em um capítulo
```
Input: "Mateus 5:1-3, 5-7"
Parse result: {chapter: 5, verses: [], ranges: [[1, 3], [5, 7]]}
Modal mostra: versículos 1, 2, 3, 5, 6, 7
```

### ✓ Caso 5: Referência simples
```
Input: "João 3:16"
Parse result: {chapter: 3, verses: [16], ranges: []}
Link/Modal abre capítulo 3, versículo 16
```

---

## Impacto no Projeto

### Melhorias de Experiência do Usuário (UX)

1. **Acesso granular:** Usuários podem acessar cada capítulo individualmente
2. **Estrutura clara:** Mantém formato visual familiar enquanto oferece funcionalidade aprimorada
3. **Compatibilidade:** Todas as formas de referência bíblica funcionam (hífens, en-dash, em-dash)
4. **Redução de cliques:** Não precisa abrir referência e depois navegar entre capítulos

### Benefícios Técnicos

1. **Robustez:** Suporta vários formatos de intervalo
2. **Escalabilidade:** Suporta qualquer número de capítulos
3. **Manutenibilidade:** Código bem estruturado com separação clara de responsabilidades
4. **Performance:** Sem impacto significativo na performance (parsing é rápido)

---

## Próximos Passos Sugeridos

1. **Teste em produção:** Validar comportamento em cenários reais
2. **Feedback de usuários:** Coletar feedback sobre a nova funcionalidade
3. **Monitoramento:** Verificar se há erros de parsing em referências complexas
4. **Documentação:** Atualizar documentação de uso para mencionar suporte a múltiplos capítulos
5. **Analytics:** Rastrear quais tipos de referências são mais acessadas

---

## Conclusão

As correções implementadas resolvem completamente os problemas reportados na issue #9 e adicionam funcionalidade robusta para múltiplos capítulos. O sistema agora é mais resiliente a variações de formatação e oferece melhor experiência ao usuário para referências complexas. Pronto para produção.

````
